# This block is a workaround for https://forum.gitlab.com/t/docker-dind-stops-working-after-12-1-0-update/28664/4.
services:
  - name: docker:dind
    entrypoint: ["env", "-u", "DOCKER_HOST"]
    command: ["dockerd-entrypoint.sh"]
variables:
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_DRIVER: overlay2
  # See https://github.com/docker-library/docker/pull/166
  DOCKER_TLS_CERTDIR: ""

jar:
  stage: build
  image: zenika/kotlin:1.3.31-jdk8
  script: ./gradlew build
  artifacts:
    paths:
      - build/libs/crystal-skull-all.jar

push-image:
  stage: build
  image: docker:dind
  script:
    - echo $HEROKU_AUTH_TOKEN | docker login --username=_ --password-stdin registry.heroku.com
    - docker build -t crystal-skull .
    - docker tag crystal-skull registry.heroku.com/$HEROKU_APP/web # TODO: See if you can get rid of this line.
    - docker push registry.heroku.com/$HEROKU_APP/web
    - "echo $(docker inspect registry.heroku.com/$HEROKU_APP/web --format='{{.Id}}') > image_id.txt"
  artifacts:
    paths:
      - image_id.txt
  dependencies:
    - jar
    # only:
    # - master

test-server:
  image: zenika/kotlin:1.3.31-jdk8
  script: ./gradlew test

test-spec:
  image: node
  script:
    - npm i -g @stoplight/spectral
    - spectral lint spec.oas3.json

pages:
  stage: deploy
  image: node
  script:
    - npm i -g redoc-cli
    - redoc-cli bundle spec.oas3.json
    - mkdir public
    - mv redoc-static.html public/index.html
  artifacts:
    paths:
      - public
  only:
    - master

release-image:
  # stage: deploy
  script: # TODO: Don't use variables; inline.
    - imageId=$(cat image_id.txt)
    - >
      payload='{"updates":[{"type":"web","docker_image":"'"$imageId"'"}]}'
    - >
      curl -n -X PATCH https://api.heroku.com/apps/"$HEROKU_APP"/formation \
        -d "$payload" \
        -H "Content-Type: application/json" \
        -H "Accept: application/vnd.heroku+json; version=3.docker-releases" \
        -H "Authorization: Bearer $HEROKU_AUTH_TOKEN"
    # only:
    # - master
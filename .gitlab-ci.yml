variables:
  DOCKER_DRIVER: overlay2
  # Create the certificates inside this directory for both the server
  # and client. The certificates used by the client will be created in
  # /certs/client so we only need to share this directory with the
  # volume mount in `config.toml`.
  DOCKER_TLS_CERTDIR: "/certs"

services:
  - docker:19.03.0-dind

stages: [test, build, deploy]

test-server:
  stage: test
  image: docker/compose
  script: docker-compose -f docker/docker-compose.yml -f docker/docker-compose.override.yml --project-directory .
    run test gradle --no-daemon test
  artifacts:
    when: always
    paths: [build/reports/tests/test/]

test-spec:
  stage: test
  image: node
  script: npx @stoplight/spectral lint docs/openapi.yaml

build-docs:
  stage: build
  image: node
  script: npx redoc-cli bundle docs/openapi.yaml --title 'Crystal Skull'
  artifacts:
    paths: [redoc-static.html]
  only: [master]

github-release:
  stage: deploy
  image: openjdk:8
  script: ./gradlew --no-daemon githubRelease -PGITHUB_TOKEN=$GITHUB_TOKEN
  only: [master]

pages:
  stage: deploy
  script:
    - mkdir public
    - cp redoc-static.html public/index.html
  artifacts:
    paths: [public]
  only: [master]